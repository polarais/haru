# haru ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ì„¤ê³„

## 1. ê°œìš”

haru ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ëŠ” Supabase(PostgreSQL)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. 
ì‚¬ìš©ìì˜ ê°ì • ì¼ê¸°, AI ì„±ì°° ë‚´ìš©, ì‚¬ì§„ ë“±ì„ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ìœ¼ë¡œ ì €ì¥í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.

## 2. ë°ì´í„°ë² ì´ìŠ¤ ì•„í‚¤í…ì²˜

### 2.1 ê¸°ìˆ  ìŠ¤íƒ
- **DBMS**: PostgreSQL (Supabase)
- **ì¸ì¦**: Supabase Auth
- **íŒŒì¼ ì €ì¥**: Supabase Storage
- **ì‹¤ì‹œê°„ ë™ê¸°í™”**: Supabase Realtime
- **ë²¡í„° ê²€ìƒ‰**: Supabase Vector (í–¥í›„ í™•ì¥)

### 2.2 ì£¼ìš” íŠ¹ì§•
- Row Level Security (RLS)ë¥¼ í†µí•œ ë°ì´í„° ë³´ì•ˆ
- ìë™ íƒ€ì„ìŠ¤íƒ¬í”„ ê´€ë¦¬
- ì†Œí”„íŠ¸ ì‚­ì œ ì§€ì›
- íš¨ìœ¨ì ì¸ ì¸ë±ì‹±

## 3. Entity Relationship Diagram

```mermaid
erDiagram
    USERS ||--|| PROFILES : extends
    PROFILES ||--|| USER_SETTINGS : has
    PROFILES ||--o{ ENTRIES : writes
    PROFILES ||--o{ CUSTOM_MOODS : creates
    PROFILES ||--o{ USAGE_STATS : generates
    
    ENTRIES ||--o{ ENTRY_PHOTOS : contains
    ENTRIES ||--o| AI_REFLECTIONS : has
    ENTRIES ||--o{ AI_CHAT_HISTORY : includes
    ENTRIES ||--o{ ENTRY_DRAFTS : saves
    
    AI_REFLECTIONS ||--o{ AI_CHAT_HISTORY : contains
    
    USERS {
        uuid id PK
        string email
        timestamp created_at
    }
    
    PROFILES {
        uuid id PK
        string username UK
        string display_name
        string avatar_url
        string theme_preference
        timestamp created_at
        timestamp updated_at
    }
    
    USER_SETTINGS {
        uuid user_id PK
        boolean reminder_enabled
        time reminder_time
        string default_view
        boolean ai_suggestions_enabled
        boolean auto_save_enabled
        integer auto_save_interval
        timestamp updated_at
    }
    
    ENTRIES {
        uuid id PK
        uuid user_id FK
        string title
        text content
        string mood_emoji
        date entry_date
        string write_mode
        boolean is_deleted
        timestamp created_at
        timestamp updated_at
    }
    
    ENTRY_PHOTOS {
        uuid id PK
        uuid entry_id FK
        string storage_path
        string caption
        integer position_index
        integer width
        integer height
        integer file_size
        timestamp uploaded_at
    }
    
    AI_REFLECTIONS {
        uuid id PK
        uuid entry_id FK
        text summary
        json insights
        string model_version
        timestamp created_at
    }
    
    AI_CHAT_HISTORY {
        uuid id PK
        uuid entry_id FK
        uuid reflection_id FK
        string message_type
        text content
        integer sequence_number
        timestamp created_at
    }
    
    CUSTOM_MOODS {
        uuid id PK
        uuid user_id FK
        string emoji
        string label
        integer usage_count
        timestamp created_at
    }
    
    ENTRY_DRAFTS {
        uuid id PK
        uuid user_id FK
        uuid entry_id FK
        string title
        text content
        string mood_emoji
        json metadata
        timestamp saved_at
    }
    
    USAGE_STATS {
        uuid id PK
        uuid user_id FK
        date stat_date
        integer entries_count
        integer photos_count
        integer ai_interactions
        json mood_distribution
    }
```

## 4. í…Œì´ë¸” ìƒì„¸ ì„¤ê³„

### 4.1 ì‚¬ìš©ì ê´€ë ¨ í…Œì´ë¸”

#### profiles (ì‚¬ìš©ì í”„ë¡œí•„)
```sql
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    username TEXT UNIQUE NOT NULL,
    display_name TEXT,
    avatar_url TEXT,
    theme_preference TEXT DEFAULT 'pink',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- íŠ¸ë¦¬ê±°: updated_at ìë™ ì—…ë°ì´íŠ¸
CREATE TRIGGER update_profiles_updated_at
    BEFORE UPDATE ON profiles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

#### user_settings (ì‚¬ìš©ì ì„¤ì •)
```sql
CREATE TABLE user_settings (
    user_id UUID PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
    reminder_enabled BOOLEAN DEFAULT false,
    reminder_time TIME,
    default_view TEXT DEFAULT 'calendar' CHECK (default_view IN ('calendar', 'timeline')),
    ai_suggestions_enabled BOOLEAN DEFAULT true,
    auto_save_enabled BOOLEAN DEFAULT true,
    auto_save_interval INTEGER DEFAULT 30, -- seconds
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.2 ì¼ê¸° ê´€ë ¨ í…Œì´ë¸”

#### entries (ì¼ê¸° í•­ëª©)
```sql
CREATE TABLE entries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    mood_emoji TEXT NOT NULL,
    entry_date DATE NOT NULL DEFAULT CURRENT_DATE,
    write_mode TEXT DEFAULT 'journal' CHECK (write_mode IN ('journal', 'chat')),
    is_deleted BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- í•˜ë£¨ 3ê°œ ì œí•œì„ ìœ„í•œ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION check_daily_entry_limit()
RETURNS TRIGGER AS $$
BEGIN
    IF (
        SELECT COUNT(*)
        FROM entries
        WHERE user_id = NEW.user_id
        AND entry_date = NEW.entry_date
        AND is_deleted = false
    ) >= 3 THEN
        RAISE EXCEPTION 'Daily entry limit (3) exceeded';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER enforce_daily_entry_limit
    BEFORE INSERT ON entries
    FOR EACH ROW
    EXECUTE FUNCTION check_daily_entry_limit();
```

#### entry_photos (ì¼ê¸° ì‚¬ì§„)
```sql
CREATE TABLE entry_photos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entry_id UUID NOT NULL REFERENCES entries(id) ON DELETE CASCADE,
    storage_path TEXT NOT NULL,
    caption TEXT,
    position_index INTEGER NOT NULL,
    width INTEGER,
    height INTEGER,
    file_size INTEGER, -- bytes
    uploaded_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### entry_drafts (ì„ì‹œ ì €ì¥)
```sql
CREATE TABLE entry_drafts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    entry_id UUID REFERENCES entries(id) ON DELETE CASCADE, -- NULL for new entries
    title TEXT,
    content TEXT,
    mood_emoji TEXT,
    metadata JSONB DEFAULT '{}', -- ì‚¬ì§„ ì •ë³´, ì‘ì„± ëª¨ë“œ ë“±
    saved_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ ì„ì‹œì €ì¥ë§Œ ìœ ì§€
CREATE UNIQUE INDEX idx_one_draft_per_user 
ON entry_drafts(user_id) 
WHERE entry_id IS NULL;
```

### 4.3 AI ê´€ë ¨ í…Œì´ë¸”

#### ai_reflections (AI ì„±ì°°)
```sql
CREATE TABLE ai_reflections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entry_id UUID NOT NULL REFERENCES entries(id) ON DELETE CASCADE,
    summary TEXT NOT NULL,
    insights JSONB DEFAULT '[]', -- êµ¬ì¡°í™”ëœ ì¸ì‚¬ì´íŠ¸
    model_version TEXT DEFAULT 'gpt-4',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¼ê¸°ë‹¹ í•˜ë‚˜ì˜ ì„±ì°°ë§Œ í—ˆìš©
CREATE UNIQUE INDEX idx_one_reflection_per_entry ON ai_reflections(entry_id);
```

#### ai_chat_history (AI ëŒ€í™” ê¸°ë¡)
```sql
CREATE TABLE ai_chat_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entry_id UUID REFERENCES entries(id) ON DELETE CASCADE,
    reflection_id UUID REFERENCES ai_reflections(id) ON DELETE CASCADE,
    message_type TEXT NOT NULL CHECK (message_type IN ('user', 'ai')),
    content TEXT NOT NULL,
    sequence_number INTEGER NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- ì¼ê¸° ì‘ì„± ì¤‘ ëŒ€í™” ë˜ëŠ” ì„±ì°° ëŒ€í™”
    CONSTRAINT chat_context CHECK (
        (entry_id IS NOT NULL AND reflection_id IS NULL) OR 
        (entry_id IS NULL AND reflection_id IS NOT NULL)
    )
);
```

### 4.4 ê¸°íƒ€ í…Œì´ë¸”

#### custom_moods (ì»¤ìŠ¤í…€ ê°ì •)
```sql
CREATE TABLE custom_moods (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    emoji TEXT NOT NULL,
    label TEXT,
    usage_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì‚¬ìš©ìë‹¹ ì´ëª¨ì§€ ì¤‘ë³µ ë°©ì§€
CREATE UNIQUE INDEX idx_unique_emoji_per_user ON custom_moods(user_id, emoji);
```

#### usage_stats (ì‚¬ìš© í†µê³„)
```sql
CREATE TABLE usage_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    stat_date DATE NOT NULL,
    entries_count INTEGER DEFAULT 0,
    photos_count INTEGER DEFAULT 0,
    ai_interactions INTEGER DEFAULT 0,
    mood_distribution JSONB DEFAULT '{}', -- {"ğŸ˜Š": 5, "ğŸ˜¢": 2, ...}
    CONSTRAINT unique_daily_stat UNIQUE (user_id, stat_date)
);
```

## 5. ì¸ë±ìŠ¤ ì„¤ê³„

```sql
-- ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
CREATE INDEX idx_entries_user_date ON entries(user_id, entry_date DESC) WHERE is_deleted = false;
CREATE INDEX idx_entries_created ON entries(created_at DESC) WHERE is_deleted = false;
CREATE INDEX idx_photos_entry ON entry_photos(entry_id, position_index);
CREATE INDEX idx_reflections_entry ON ai_reflections(entry_id);
CREATE INDEX idx_chat_history_entry ON ai_chat_history(entry_id, sequence_number);
CREATE INDEX idx_chat_history_reflection ON ai_chat_history(reflection_id, sequence_number);
CREATE INDEX idx_custom_moods_user ON custom_moods(user_id, usage_count DESC);
CREATE INDEX idx_stats_user_date ON usage_stats(user_id, stat_date DESC);

-- ì „ë¬¸ ê²€ìƒ‰ì„ ìœ„í•œ ì¸ë±ìŠ¤ (ì„ íƒì )
CREATE INDEX idx_entries_search ON entries 
USING gin(to_tsvector('korean', title || ' ' || content)) 
WHERE is_deleted = false;
```

## 6. Row Level Security (RLS) ì •ì±…

```sql
-- RLS í™œì„±í™”
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE entry_photos ENABLE ROW LEVEL SECURITY;
ALTER TABLE entry_drafts ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_reflections ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_chat_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE custom_moods ENABLE ROW LEVEL SECURITY;
ALTER TABLE usage_stats ENABLE ROW LEVEL SECURITY;

-- profiles ì •ì±…
CREATE POLICY "Users can view own profile" ON profiles
    FOR SELECT USING (auth.uid() = id);
    
CREATE POLICY "Users can update own profile" ON profiles
    FOR UPDATE USING (auth.uid() = id);

-- entries ì •ì±…
CREATE POLICY "Users can CRUD own entries" ON entries
    FOR ALL USING (auth.uid() = user_id);

-- entry_photos ì •ì±…
CREATE POLICY "Users can manage photos of own entries" ON entry_photos
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM entries 
            WHERE entries.id = entry_photos.entry_id 
            AND entries.user_id = auth.uid()
        )
    );

-- ê¸°íƒ€ í…Œì´ë¸”ë“¤ë„ ë™ì¼í•œ íŒ¨í„´ìœ¼ë¡œ ì •ì±… ì ìš©
```

## 7. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ë°±ì—… ì „ëµ

### 7.1 ë§ˆì´ê·¸ë ˆì´ì…˜
- Supabase CLIë¥¼ í†µí•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬
- ê° ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­ì€ ë²„ì „ ê´€ë¦¬
- ë¡¤ë°± ê°€ëŠ¥í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

### 7.2 ë°±ì—…
- Supabase ìë™ ë°±ì—… (Point-in-time Recovery)
- ì£¼ê°„ ì „ì²´ ë°±ì—…
- ì¤‘ìš” ë°ì´í„° ì¼ì¼ ì¦ë¶„ ë°±ì—…

### 7.3 ë°ì´í„° ë³´ì¡´
- ì‚­ì œëœ ì¼ê¸°ëŠ” 30ì¼ê°„ ë³´ê´€ (is_deleted = true)
- AI ëŒ€í™” ê¸°ë¡ì€ ì˜êµ¬ ë³´ì¡´
- ì‚¬ìš©ì íƒˆí‡´ ì‹œ ìµëª…í™” ì²˜ë¦¬

## 8. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### 8.1 ì¿¼ë¦¬ ìµœì í™”
- ë³µí•© ì¸ë±ìŠ¤ë¥¼ í†µí•œ ë¹ ë¥¸ ì¡°íšŒ
- í˜ì´ì§€ë„¤ì´ì…˜ ì ìš© (cursor-based)
- ë¶ˆí•„ìš”í•œ JOIN ìµœì†Œí™”

### 8.2 ìºì‹± ì „ëµ
- ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„° Redis ìºì‹± (í–¥í›„)
- ì •ì  ë°ì´í„° CDN ìºì‹±
- API ì‘ë‹µ ìºì‹±

### 8.3 í™•ì¥ì„±
- íŒŒí‹°ì…”ë‹ ì¤€ë¹„ (entry_date ê¸°ì¤€)
- ì½ê¸° ì „ìš© ë³µì œë³¸ í™œìš©
- ë¹„ë™ê¸° ì‘ì—… í ë„ì… (AI ì²˜ë¦¬)

## 9. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 9.1 ë°ì´í„° ì•”í˜¸í™”
- ì „ì†¡ ì¤‘ ì•”í˜¸í™” (HTTPS/TLS)
- ì €ì¥ ì‹œ ì•”í˜¸í™” (Supabase ê¸°ë³¸ ì œê³µ)
- ë¯¼ê° ì •ë³´ ì¶”ê°€ ì•”í˜¸í™”

### 9.2 ì ‘ê·¼ ì œì–´
- RLSë¥¼ í†µí•œ ë°ì´í„° ê²©ë¦¬
- API í‚¤ ê´€ë¦¬
- Rate limiting

### 9.3 ê°ì‚¬ ë¡œê·¸
- ì¤‘ìš” ì‘ì—… ë¡œê¹…
- ì ‘ê·¼ ê¸°ë¡ ë³´ê´€
- ì´ìƒ í–‰ë™ íƒì§€

## 10. í–¥í›„ í™•ì¥ ê³„íš

### 10.1 ì¶”ê°€ ê¸°ëŠ¥
- íƒœê·¸ ì‹œìŠ¤í…œ
- ì¼ê¸° ê³µìœ  ê¸°ëŠ¥
- ê·¸ë£¹ ì¼ê¸°ì¥
- ìŒì„± ë©”ëª¨

### 10.2 AI ê³ ë„í™”
- ë²¡í„° ì„ë² ë”© ì €ì¥
- ìœ ì‚¬ ì¼ê¸° ê²€ìƒ‰
- ê°ì • íŒ¨í„´ ë¶„ì„
- ë§ì¶¤í˜• ì¶”ì²œ

### 10.3 ë¶„ì„ ê¸°ëŠ¥
- ìƒì„¸ í†µê³„ ëŒ€ì‹œë³´ë“œ
- ê°ì • íŠ¸ë Œë“œ ë¶„ì„
- ì—°ê°„ ë¦¬í¬íŠ¸
- ë°ì´í„° ì‹œê°í™”