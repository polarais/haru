# haru 프로젝트 테스트 시나리오

## 1. 개요

이 문서는 haru 디지털 감정 일기 애플리케이션의 테스트 시나리오를 정의합니다.
제품 선언서, 요건 정의서, 데이터베이스 구조를 기반으로 작성되었으며, 이미 구현된 코드의 테스트 방향성도 포함합니다.

## 2. 테스트 전략

### 2.1 테스트 계층
- **Unit Tests**: 개별 함수, 유틸리티, 컴포넌트
- **Integration Tests**: API, 데이터베이스, 컴포넌트 간 상호작용
- **E2E Tests**: 전체 사용자 플로우

### 2.2 테스트 환경
- **개발/테스트**: 로컬 Supabase 사용
- **지속적 통합**: GitHub Actions에서 로컬 Supabase 실행
- **데이터 격리**: 각 테스트는 독립된 데이터 세트 사용

## 3. 기능별 테스트 시나리오

### 3.1 사용자 인증 (AUTH)

#### AUTH-01: 회원가입
```typescript
describe('회원가입 기능', () => {
  it('유효한 이메일과 비밀번호로 회원가입 성공', async () => {
    // Given: 신규 사용자 정보
    // When: 회원가입 시도
    // Then: 계정 생성 성공, 인증 이메일 발송
  })
  
  it('이미 존재하는 이메일로 회원가입 실패', async () => {
    // Given: 기존 사용자의 이메일
    // When: 같은 이메일로 회원가입 시도
    // Then: 중복 에러 반환
  })
  
  it('유효하지 않은 이메일 형식으로 회원가입 실패', async () => {
    // Given: 잘못된 이메일 형식
    // When: 회원가입 시도
    // Then: 유효성 검증 에러 반환
  })
})
```

#### AUTH-02: 로그인/로그아웃
```typescript
describe('로그인 기능', () => {
  it('올바른 자격 증명으로 로그인 성공', async () => {
    // Given: 유효한 사용자 계정
    // When: 올바른 이메일/비밀번호로 로그인
    // Then: 대시보드로 리다이렉트, 세션 생성
  })
  
  it('잘못된 비밀번호로 로그인 실패', async () => {
    // Given: 존재하는 이메일, 잘못된 비밀번호
    // When: 로그인 시도
    // Then: 인증 실패 에러 반환
  })
  
  it('로그아웃 시 세션 정리', async () => {
    // Given: 로그인된 사용자
    // When: 로그아웃 실행
    // Then: 세션 삭제, 로그인 페이지로 리다이렉트
  })
})
```

### 3.2 일기 작성 (WRITE)

#### WRITE-01: Journal 모드 일기 작성
```typescript
describe('Journal 모드 일기 작성', () => {
  it('제목, 내용, 기분으로 일기 작성 성공', async () => {
    // Given: 로그인된 사용자, 오늘 일기 3개 미만
    // When: 제목, 내용, 기분 이모지 선택 후 저장
    // Then: 일기 저장 성공, 대시보드로 돌아가기
  })
  
  it('실시간 자동 저장 기능', async () => {
    // Given: 일기 작성 중
    // When: 30초 간격으로 내용 입력
    // Then: 자동으로 임시 저장됨
  })
  
  it('텍스트 중간에 사진 삽입 기능', async () => {
    // Given: Journal 모드에서 텍스트 작성 중
    // When: 커서 위치에서 이미지 업로드 (5MB 이하)
    // Then: content 배열에 paragraph → image → paragraph 순서로 저장
    //       [
    //         { type: "paragraph", text: "첫 번째 문단" },
    //         { type: "image", url: "...", caption: "사진 설명" },
    //         { type: "paragraph", text: "두 번째 문단" }
    //       ]
  })
  
  it('사진 여러 장 첨부 및 순서 변경', async () => {
    // Given: 일기에 텍스트와 이미지가 혼재된 상태
    // When: 추가 이미지 업로드 및 드래그로 순서 변경
    // Then: content 배열 인덱스 순서 업데이트
  })
  
  it('사진 캡션 추가/수정', async () => {
    // Given: 업로드된 이미지
    // When: 이미지 클릭하여 캡션 입력/수정
    // Then: content에서 해당 image 블록의 caption 필드 업데이트
  })
})
```

#### WRITE-02: AI Chat 모드 일기 작성
```typescript
describe('AI Chat 모드 일기 작성', () => {
  it('AI와 대화하며 일기 내용 구성', async () => {
    // Given: AI Chat 모드 선택
    // When: AI와 대화 진행
    // Then: ai_chats JSON에 대화 내역 저장
  })
  
  it('Journal ↔ AI Chat 모드 전환', async () => {
    // Given: 한 모드에서 작성 중
    // When: 다른 모드로 전환
    // Then: 기존 내용 유지, 모드 변경 성공
  })
})
```

#### WRITE-03: 일기 작성 제한
```typescript
describe('일기 작성 제한', () => {
  it('하루 최대 3개 일기 작성 제한', async () => {
    // Given: 오늘 이미 3개의 일기 작성됨
    // When: 새 일기 작성 시도
    // Then: 작성 제한 알림 표시
  })
  
  it('날짜가 바뀌면 제한 초기화', async () => {
    // Given: 어제 3개 일기 작성됨
    // When: 오늘 새 일기 작성 시도
    // Then: 정상적으로 작성 가능
  })
})
```

### 3.3 일기 조회 (VIEW)

#### VIEW-01: 캘린더 뷰
```typescript
describe('캘린더 뷰', () => {
  it('월별 감정 캘린더 표시', async () => {
    // Given: 여러 일기가 작성된 상태
    // When: 캘린더 뷰 접근
    // Then: 각 날짜에 기분 이모지 표시
  })
  
  it('일기 있는 날짜 클릭 시 일기 패널 열기', async () => {
    // Given: 일기가 있는 날짜
    // When: 해당 날짜 클릭
    // Then: 일기 상세 패널 표시
  })
  
  it('일기 없는 날짜 클릭 시 작성 모드로 이동', async () => {
    // Given: 일기가 없는 날짜
    // When: 해당 날짜 클릭
    // Then: 해당 날짜로 일기 작성 페이지 이동
  })
})
```

#### VIEW-02: 타임라인 뷰
```typescript
describe('타임라인 뷰', () => {
  it('시간순 일기 목록 표시 (AI 요약)', async () => {
    // Given: 여러 일기와 AI 요약이 있는 상태
    // When: 타임라인 뷰 접근
    // Then: AI 요약 내용으로 일기 목록 표시
  })
  
  it('타임라인에서 일기 클릭 시 상세 보기', async () => {
    // Given: 타임라인에 일기 목록
    // When: 특정 일기 클릭
    // Then: 해당 일기 상세 패널 표시
  })
})
```

#### VIEW-03: 일기 상세보기 및 관리
```typescript
describe('일기 상세보기', () => {
  it('일기 전체 내용, 사진, AI 대화 조회', async () => {
    // Given: 완전한 일기 데이터
    // When: 일기 상세 보기 접근
    // Then: content, ai_chats, 사진 모두 표시
  })
  
  it('인라인 편집 기능', async () => {
    // Given: 일기 상세 보기 상태
    // When: 내용 직접 수정
    // Then: 실시간 저장, updated_at 갱신
  })
  
  it('일기 삭제 (소프트 삭제)', async () => {
    // Given: 일기 상세 보기 상태
    // When: 삭제 버튼 클릭 후 확인
    // Then: is_deleted = true로 설정
  })
})
```

### 3.4 AI 기능 (AI)

#### AI-01: AI 요약 및 대화
```typescript
describe('AI 기능', () => {
  it('일기 내용 기반 AI 요약 생성', async () => {
    // Given: 작성된 일기
    // When: AI 요약 요청
    // Then: summary 필드에 요약 저장
  })
  
  it('Journal 모드 일기에 대한 AI 대화', async () => {
    // Given: Journal 모드로 작성된 일기
    // When: "AI와 대화" 버튼 클릭
    // Then: AI와 대화 페이지로 이동, 대화 내역 저장
  })
  
  it('AI 응답 시간 성능 (1초 이내)', async () => {
    // Given: AI 대화 요청
    // When: 메시지 전송
    // Then: 1초 이내 첫 응답 시작
  })
})
```

## 4. 데이터 모델 테스트 시나리오

### 4.1 user_profiles 테이블
```typescript
describe('사용자 프로필 모델', () => {
  it('Supabase Auth 사용자와 연동', async () => {
    // Given: 새로운 auth.users 생성
    // When: user_profiles 레코드 생성
    // Then: auth.users.id와 profiles.id 일치
  })
  
  it('기본 설정값 적용', async () => {
    // Given: 새 사용자 프로필
    // When: 프로필 생성 시 설정값 미지정
    // Then: 기본값 적용 (theme_preference: 'pink', auto_save_enabled: true)
  })
  
  it('RLS 정책으로 본인 데이터만 접근', async () => {
    // Given: 두 개의 사용자 계정
    // When: 사용자 A가 사용자 B의 프로필 조회 시도
    // Then: 접근 거부
  })
})
```

### 4.2 diaries 테이블
```typescript
describe('일기 모델', () => {
  it('content JSON 구조 검증 (텍스트+이미지 혼재)', async () => {
    // Given: paragraph와 image 블록이 혼재된 content
    // When: 일기 저장
    // Then: JSON 구조 유효성 검증 통과
    //       배열 인덱스가 블록 순서를 정확히 나타냄
    //       각 블록의 type 필드가 올바름 ("paragraph" | "image")
  })
  
  it('이미지 메타데이터 저장', async () => {
    // Given: 이미지 업로드
    // When: content에 image 블록 추가
    // Then: url, caption, meta(width, height, size) 모두 저장됨
  })
  
  it('ai_chats JSON 구조 검증', async () => {
    // Given: user/assistant 대화 배열
    // When: AI 대화 저장
    // Then: speaker, message, timestamp 필드 검증
  })
  
  it('하루 3개 제한 트리거 동작', async () => {
    // Given: 특정 날짜에 이미 3개 일기
    // When: 같은 날짜에 4번째 일기 삽입 시도
    // Then: 트리거에 의해 예외 발생
  })
  
  it('소프트 삭제 동작', async () => {
    // Given: 존재하는 일기
    // When: 삭제 처리
    // Then: is_deleted = true, 실제 레코드는 유지
  })
})
```

## 5. 유틸리티 함수 테스트 (이미 구현됨)

### 5.1 날짜 유틸리티 (lib/utils/date.ts)
```typescript
// 이미 구현된 테스트들:
describe('formatDateKorean', () => {
  it('정상적인 날짜 문자열을 한국어로 포맷팅')
  it('유효하지 않은 날짜 문자열 처리')
  it('빈 문자열 처리')
  it('null/undefined 처리')
})

describe('isToday', () => {
  it('오늘 날짜 정확히 판단')
  it('다른 날짜는 false 반환')
  it('유효하지 않은 날짜는 false 반환')
})

describe('getRelativeDate', () => {
  it('오늘, 어제, 내일 상대적 표현')
  it('그 외 날짜는 한국어 형식으로 반환')
  it('유효하지 않은 날짜 처리')
})
```

### 5.2 브라우저 테스트 페이지 (app/test-utils/page.tsx)
- TDD로 구현된 날짜 유틸리티를 브라우저에서 직접 테스트
- 사용자가 날짜를 입력하여 함수 결과 확인 가능
- 빠른 테스트 버튼 (오늘, 어제, 내일)

## 6. UI/UX 테스트 시나리오

### 6.1 반응형 디자인
```typescript
describe('반응형 디자인', () => {
  it('데스크톱 레이아웃 (1024px+)', async () => {
    // Given: 데스크톱 화면 크기
    // When: 애플리케이션 렌더링
    // Then: 사이드바, 메인 영역, 패널 올바른 배치
  })
  
  it('모바일 레이아웃 (768px 미만)', async () => {
    // Given: 모바일 화면 크기
    // When: 애플리케이션 렌더링
    // Then: 사이드바 오버레이, 풀스크린 패널
  })
})
```

### 6.2 사이드바 네비게이션
```typescript
describe('사이드바 동작', () => {
  it('write/reflection 페이지에서 사이드바 숨김', async () => {
    // Given: 일기 작성 또는 AI 대화 페이지
    // When: 페이지 렌더링
    // Then: 사이드바 숨겨짐
  })
  
  it('대시보드에서 사이드바 표시', async () => {
    // Given: 메인 대시보드 페이지
    // When: 페이지 렌더링
    // Then: 사이드바 표시됨
  })
})
```

### 6.3 애니메이션 및 전환
```typescript
describe('UI 애니메이션', () => {
  it('패널 열기/닫기 애니메이션 (300ms)', async () => {
    // Given: 일기 패널 닫힌 상태
    // When: 일기 클릭하여 패널 열기
    // Then: 300ms ease-in-out 애니메이션 실행
  })
  
  it('사이드바 슬라이드 애니메이션', async () => {
    // Given: 모바일에서 사이드바 닫힌 상태
    // When: 햄버거 메뉴 클릭
    // Then: 슬라이드 애니메이션과 함께 사이드바 표시
  })
})
```

## 7. 통합 테스트 시나리오

### 7.1 전체 사용자 플로우
```typescript
describe('완전한 사용자 여정', () => {
  it('회원가입부터 일기 작성까지', async () => {
    // Given: 신규 사용자
    // When: 1) 회원가입 → 2) 이메일 인증 → 3) 로그인 → 4) 일기 작성
    // Then: 전체 플로우 성공, 일기 저장 확인
  })
  
  it('AI Chat 모드 전체 플로우', async () => {
    // Given: 로그인된 사용자
    // When: 1) AI Chat 모드 선택 → 2) AI와 대화 → 3) 요약 생성 → 4) 저장
    // Then: ai_chats와 summary 모두 저장됨
  })
})
```

### 7.2 데이터 일관성 테스트
```typescript
describe('데이터 일관성', () => {
  it('사용자 삭제 시 관련 데이터 cascade 삭제', async () => {
    // Given: 일기가 있는 사용자
    // When: 사용자 계정 삭제
    // Then: user_profiles와 diaries 모두 삭제됨
  })
  
  it('트랜잭션 롤백 처리', async () => {
    // Given: 일기 저장 중 일부 단계에서 실패
    // When: 오류 발생
    // Then: 전체 트랜잭션 롤백, 부분 저장 방지
  })
})
```

## 8. 성능 테스트 시나리오

### 8.1 응답 시간
```typescript
describe('성능 요구사항', () => {
  it('초기 로딩 3초 이내', async () => {
    // Given: 새로고침된 브라우저
    // When: 애플리케이션 첫 로드
    // Then: 3초 이내 대시보드 표시
  })
  
  it('일기 저장 2초 이내', async () => {
    // Given: 일기 작성 완료
    // When: 저장 버튼 클릭
    // Then: 2초 이내 저장 완료 응답
  })
  
  it('AI 응답 1초 이내 시작', async () => {
    // Given: AI 대화 요청
    // When: 메시지 전송
    // Then: 1초 이내 첫 토큰 응답 시작
  })
})
```

### 8.2 대용량 데이터 처리
```typescript
describe('데이터 처리 성능', () => {
  it('100개 일기 목록 조회 성능', async () => {
    // Given: 100개의 일기가 저장된 상태
    // When: 타임라인 뷰 로드
    // Then: 5초 이내 목록 표시
  })
  
  it('큰 이미지 파일 업로드 (5MB)', async () => {
    // Given: 5MB 이미지 파일
    // When: 일기에 이미지 첨부
    // Then: 10초 이내 업로드 완료
  })
})
```

## 9. 보안 테스트 시나리오

### 9.1 인증 및 권한
```typescript
describe('보안 테스트', () => {
  it('비로그인 사용자의 보호된 페이지 접근 차단', async () => {
    // Given: 비로그인 상태
    // When: /dashboard 접근 시도
    // Then: 로그인 페이지로 리다이렉트
  })
  
  it('다른 사용자의 일기 접근 차단 (RLS)', async () => {
    // Given: 사용자 A로 로그인
    // When: 사용자 B의 일기 ID로 직접 접근
    // Then: 접근 거부, 404 또는 403 응답
  })
})
```

### 9.2 입력 검증
```typescript
describe('입력 검증', () => {
  it('SQL Injection 방어', async () => {
    // Given: SQL Injection 시도 입력값
    // When: 일기 내용에 악성 SQL 입력
    // Then: 쿼리 실행되지 않고 안전하게 저장
  })
  
  it('XSS 방어', async () => {
    // Given: 스크립트 태그가 포함된 입력
    // When: 일기 내용에 <script> 태그 입력
    // Then: 렌더링 시 이스케이프되어 안전하게 표시
  })
})
```

## 10. 에러 처리 테스트 시나리오

### 10.1 네트워크 오류
```typescript
describe('에러 처리', () => {
  it('네트워크 연결 실패 시 재시도', async () => {
    // Given: 네트워크 연결 불안정
    // When: 일기 저장 시도
    // Then: 자동 재시도, 사용자에게 상태 표시
  })
  
  it('AI API 응답 실패 시 대체 메시지', async () => {
    // Given: AI API 서비스 장애
    // When: AI 대화 시도
    // Then: 친화적인 오류 메시지 표시, 나중에 시도 옵션 제공
  })
})
```

### 10.2 데이터 유실 방지
```typescript
describe('데이터 보호', () => {
  it('브라우저 새로고침 시 작성 중 일기 복원', async () => {
    // Given: 일기 작성 중 자동 저장된 상태
    // When: 브라우저 새로고침
    // Then: 작성 중이던 내용 자동 복원
  })
  
  it('서버 오류 시 로컬 백업 생성', async () => {
    // Given: 서버 저장 실패
    // When: 일기 저장 시도
    // Then: 로컬스토리지에 임시 백업, 복구 옵션 제공
  })
})
```

## 11. 접근성 테스트 시나리오

### 11.1 키보드 네비게이션
```typescript
describe('접근성', () => {
  it('Tab 키로 모든 요소 접근 가능', async () => {
    // Given: 일기 작성 페이지
    // When: Tab 키로 순차 이동
    // Then: 모든 입력 요소와 버튼 접근 가능
  })
  
  it('Enter/Space 키로 버튼 활성화', async () => {
    // Given: 버튼 요소에 포커스
    // When: Enter 또는 Space 키 입력
    • Then: 해당 버튼 동작 실행
  })
})
```

## 12. 테스트 자동화 전략

### 12.1 CI/CD 파이프라인
```yaml
# GitHub Actions 워크플로우 예시
name: Test Suite
on: [push, pull_request]
jobs:
  test:
    - 로컬 Supabase 인스턴스 실행
    - 단위 테스트 실행
    - 통합 테스트 실행
    - 테스트 커버리지 90% 이상 확인
    - E2E 테스트 실행 (주요 플로우만)
```

### 12.2 테스트 데이터 관리
```typescript
describe('테스트 데이터 관리', () => {
  beforeEach(async () => {
    // 테스트용 사용자 계정 생성
    // 기본 일기 데이터 시드
    // 테스트 이미지 파일 준비
  })
  
  afterEach(async () => {
    // 테스트 데이터 정리
    // 업로드된 파일 삭제
    // 데이터베이스 초기화
  })
})
```

## 13. 테스트 커버리지 목표

### 13.1 커버리지 기준
- **전체 코드 커버리지**: 90% 이상
- **유틸리티 함수**: 100% (현재 달성)
- **API 엔드포인트**: 95% 이상
- **React 컴포넌트**: 85% 이상

### 13.2 현재 상태
- ✅ **날짜 유틸리티**: 100% (17개 테스트 통과)
- 🔄 **API 계층**: 구현 예정
- 🔄 **UI 컴포넌트**: 구현 예정
- 🔄 **통합 테스트**: 구현 예정

## 14. 결론

이 테스트 시나리오는 haru 프로젝트의 품질 보증을 위한 포괄적인 계획입니다.
각 기능별로 단위 테스트부터 통합 테스트까지 체계적으로 구성하여,
사용자에게 안정적이고 신뢰할 수 있는 서비스를 제공하는 것을 목표로 합니다.

**다음 단계**: Phase 3 (API 계층 TDD 적용)부터 이 시나리오를 기반으로 실제 테스트 구현을 진행합니다.